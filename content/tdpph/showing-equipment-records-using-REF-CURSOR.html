<!DOCTYPE html
  SYSTEM "about:legacy-compat">

<!-- saved from url=(0023)https://docs.oracle.com -->

<html xml:lang="en-us" lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Showing Equipment Records by Using a REF CURSOR</title>
      <meta property="og:site_name" content="Oracle Help Center">
      <meta property="og:title" content="2 Day + PHP Developer's Guide">
      <meta property="og:description" content="">
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css">
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico">
      <meta name="application-name" content="2 Day + PHP Developer's Guide">
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)">
      <meta name="plugin" content="SP_docbuilder HTML plugin release 17.8.1">
      <link rel="alternate" href="2-day-php-developers-guide.pdf" title="PDF File" type="application/pdf">
      <meta name="robots" content="all">
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
      <meta name="dcterms.created" content="2017-10-18T11:39:07-07:00">
      <meta name="dcterms.title" content="2 Day + PHP Developer's Guide">
      <meta name="dcterms.dateCopyrighted" content="2010, 2017">
      <meta name="dcterms.category" content="database">
      <meta name="dcterms.identifier" content="E85807-01">
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/12.2">
      <meta name="dcterms.release" content="Release 12.2">
      <link rel="prev" href="paging-through-employee-data.html" title="Previous" type="text/html">
      <link rel="next" href="error-handling.html" title="Next" type="text/html">
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script data-main="/sp_common/book-template/ohc-book-template/js/book-config" src="/sp_common/book-template/requirejs/require.js"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">
            {
                "primary":
                {
                    "category":{
                      "short_name":"database",
                      "element_name":"Database",
                      "display_in_url":true
                    },
                    "suite":{
                      "short_name":"oracle",
                      "element_name":"Oracle",
                      "display_in_url":true
                    },
                    "product_group":{
                      "short_name":"not-applicable",
                      "element_name":"Not applicable",
                      "display_in_url":false
                    },
                    "product":{
                      "short_name":"oracle-database",
                      "element_name":"Oracle Database",
                      "display_in_url":true
                    },
                    "release":{
                      "short_name":"12.2",
                      "element_name":"Release 12.2",
                      "display_in_url":true
                    },
                    "platform":{
                      "short_name":"",
                      "element_name":"",
                      "display_in_url":false
                    },
                    "component":{
                      "short_name":"",
                      "element_name":"",
                      "display_in_url":false
                    }
                }
            }
            </script>
      
    <meta name="dcterms.isVersionOf" content="TDPPH">
  </head>
   <body>
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="paging-through-employee-data.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>Previous</a>
         <a href="error-handling.html" class="pull-right">Next<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>
         <span class="fa fa-exclamation-triangle" aria-hidden="true"></span> JavaScript must be enabled to correctly display this content
        
      </div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">2 Day + PHP Developer's Guide</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">Showing Equipment Records by Using a REF CURSOR </li>
            </ol>
            <a id="GUID-81593889-92ED-48C5-B1EE-F2BBBF60F64F" name="GUID-81593889-92ED-48C5-B1EE-F2BBBF60F64F"></a><a id="TDPPH160"></a>
            
            <h2 id="TDPPH-GUID-81593889-92ED-48C5-B1EE-F2BBBF60F64F" class="sect2"><span class="enumeration_chapter">6 </span>Showing Equipment Records by Using a REF CURSOR 
            </h2>
         </header>
         <div class="ind">
            <div>
               <p>This chapter creates the report run by clicking the <span class="bold">Show</span> link next to an employees name on the <span class="bold">AnyCo Corp. Employees List</span> page from the previous chapter.
               </p>
               <p>The previous chapter showed how to fetch data from a SQL query. This chapter shows how to use a <code class="codeph">REF CURSOR</code> in PHP. The <code class="codeph">REF CURSOR</code> will fetch the names of the equipment that have been issued to an employee.
               </p>
               <p>This chapter contains the following topics:</p>
               <ul style="list-style-type: disc;">
                  <li>
                     <p><a href="showing-equipment-records-using-REF-CURSOR.html#GUID-74C30809-3129-4020-9CA6-D4B022385B47">Introduction to PL/SQL Packages and Package Bodies</a></p>
                  </li>
                  <li>
                     <p><a href="showing-equipment-records-using-REF-CURSOR.html#GUID-075E5CCA-0090-4878-8FFA-C35FF1CEF03D">Introduction to PL/SQL Stored Procedures</a></p>
                  </li>
                  <li>
                     <p><a href="showing-equipment-records-using-REF-CURSOR.html#GUID-EA342C38-FE4D-42C5-88B0-18383E6277B0">Introduction to REF CURSORs</a></p>
                  </li>
                  <li>
                     <p><a href="showing-equipment-records-using-REF-CURSOR.html#GUID-190275AA-EBAF-40D6-83CB-5ECFD5D69437">Creating the Equipment Table</a></p>
                  </li>
                  <li>
                     <p><a href="showing-equipment-records-using-REF-CURSOR.html#GUID-AB3E329D-786E-44FD-AD1C-5A7F56BBC776">Calling the REF CURSOR in PHP</a></p>
                  </li>
               </ul>
            </div><a id="TDPPH161"></a><div class="props_rev_3"><a id="GUID-74C30809-3129-4020-9CA6-D4B022385B47" name="GUID-74C30809-3129-4020-9CA6-D4B022385B47"></a><h3 id="TDPPH-GUID-74C30809-3129-4020-9CA6-D4B022385B47" class="sect3"><span class="enumeration_section">6.1 </span>Introduction to PL/SQL Packages and Package Bodies
               </h3>
               <div>
                  <p>A PL/SQL package stores related items as a single logical entity. A package is composed of two distinct pieces: </p>
                  <ul style="list-style-type: disc;">
                     <li>
                        <p>The <span class="bold">package specification</span> defines what is contained in the package; it is analogous to a header file in a language such as C++. The specification defines all public items. The specification is the published interface to a package.
                        </p>
                     </li>
                     <li>
                        <p>The <span class="bold">package body</span> contains the code for the procedures and functions defined in the specification, and the code for private procedures and functions that are not declared in the specification. This private code is only visible within the package body.
                        </p>
                     </li>
                  </ul>
                  <p>The package specification and body are stored as separate objects in the data dictionary and can be seen in the <code class="codeph">user_source</code> view. The specification is stored as the <code class="codeph">PACKAGE</code> type, and the body is stored as the <code class="codeph">PACKAGE BODY</code> type.
                  </p>
                  <p>While it is possible to have a specification without a body, as when declaring a set of public constants, it is not possible to have a body with no specification.</p>
               </div>
            </div><a id="TDPPH162"></a><div class="props_rev_3"><a id="GUID-075E5CCA-0090-4878-8FFA-C35FF1CEF03D" name="GUID-075E5CCA-0090-4878-8FFA-C35FF1CEF03D"></a><h3 id="TDPPH-GUID-075E5CCA-0090-4878-8FFA-C35FF1CEF03D" class="sect3"><span class="enumeration_section">6.2 </span>Introduction to PL/SQL Stored Procedures
               </h3>
               <div>
                  <p>A stored procedure is a named set of PL/SQL statements designed to perform an action. Stored procedures are stored inside the database. They define a programming interface for the database rather than allowing the client application to interact with database objects directly. Stored procedures are typically used for data validation or to encapsulate large, complex processing instructions that combine several SQL queries. </p>
                  <p>Stored functions have a single return value parameter. Unlike functions, procedures may or may not return values.</p>
               </div>
            </div><a id="TDPPH163"></a><div class="props_rev_3"><a id="GUID-EA342C38-FE4D-42C5-88B0-18383E6277B0" name="GUID-EA342C38-FE4D-42C5-88B0-18383E6277B0"></a><h3 id="TDPPH-GUID-EA342C38-FE4D-42C5-88B0-18383E6277B0" class="sect3"><span class="enumeration_section">6.3 </span>Introduction to REF CURSORs
               </h3>
               <div>
                  <p>Using <code class="codeph">REF</code> <code class="codeph">CURSOR</code>s is one of the most powerful, flexible, and scalable ways to return query results from an Oracle Database to a client application.
                  </p>
                  <p>A <code class="codeph">REF</code> <code class="codeph">CURSOR</code> is a PL/SQL data type whose value is the memory address of a query work area on the database. In essence, a <code class="codeph">REF</code> <code class="codeph">CURSOR</code> is a pointer or a handle to a result set on the database. 
                  </p>
                  <p><code class="codeph">REF</code> <code class="codeph">CURSOR</code>s have the following characteristics:
                  </p>
                  <ul style="list-style-type: disc;">
                     <li>
                        <p>A <code class="codeph">REF</code> <code class="codeph">CURSOR</code> refers to a memory address on the database. Therefore, the client must be connected to the database during the lifetime of the <code class="codeph">REF</code> <code class="codeph">CURSOR</code> in order to access it.
                        </p>
                     </li>
                     <li>
                        <p>A <code class="codeph">REF</code> <code class="codeph">CURSOR</code> involves an additional database round-trip. While the <code class="codeph">REF</code> <code class="codeph">CURSOR</code> is returned to the client, the actual data is not returned until the client opens the <code class="codeph">REF</code> <code class="codeph">CURSOR</code> and requests the data. Note that data is not be retrieved until the user attempts to read it.
                        </p>
                     </li>
                     <li>
                        <p>A <code class="codeph">REF</code> <code class="codeph">CURSOR</code> is not updatable. The result set represented by the <code class="codeph">REF</code> <code class="codeph">CURSOR</code> is read-only. You cannot update the database by using a <code class="codeph">REF</code> <code class="codeph">CURSOR</code>.
                        </p>
                     </li>
                     <li>
                        <p>A <code class="codeph">REF</code> <code class="codeph">CURSOR</code> is not backward scrollable. The data represented by the <code class="codeph">REF</code> <code class="codeph">CURSOR</code> is accessed in a forward-only, serial manner. You cannot position a record pointer inside the <code class="codeph">REF</code> <code class="codeph">CURSOR</code> to point to random records in the result set.
                        </p>
                     </li>
                     <li>
                        <p>A <code class="codeph">REF</code> <code class="codeph">CURSOR</code> is a PL/SQL data type. You create and return a <code class="codeph">REF</code> <code class="codeph">CURSOR</code> inside a PL/SQL code block. 
                        </p>
                     </li>
                  </ul>
               </div>
            </div><a id="TDPPH164"></a><div class="props_rev_3"><a id="GUID-190275AA-EBAF-40D6-83CB-5ECFD5D69437" name="GUID-190275AA-EBAF-40D6-83CB-5ECFD5D69437"></a><h3 id="TDPPH-GUID-190275AA-EBAF-40D6-83CB-5ECFD5D69437" class="sect3"><span class="enumeration_section">6.4 </span>Creating the Equipment Table
               </h3>
               <div>
                  <div class="section">
                     <p>This manual's example scenario is that AnyCo Corp issues each employee various pieces of equipment to do their job. An <code class="codeph">EQUIPMENT</code> table will hold the equipment names and to which employee it was issued.
                     </p>
                     <p>In SQL*Plus connect as the <code class="codeph">HR</code> user and run the following script:
                     </p><pre class="oac_no_warn" dir="ltr">sqlplus hr/welcome@localhost
</pre><pre class="oac_no_warn" dir="ltr">CREATE TABLE equipment(
    id          NUMBER PRIMARY KEY,
    employee_id REFERENCES employees(employee_id) ON DELETE CASCADE,
    equip_name  VARCHAR2(20) NOT NULL);
 
CREATE SEQUENCE equipment_seq;
CREATE TRIGGER equipment_trig BEFORE INSERT ON equipment FOR EACH ROW
BEGIN
    :NEW.id := equipment_seq.NEXTVAL;
END;
/
</pre><p>The PL/SQL sequence and trigger assign a unique key to each new equipment record as it is inserted.</p>
                     <p>If you run these statements in a SQL editor, such as in NetBeans, omit the trailing slash ('<code class="codeph">/</code>') in the <code class="codeph">CREATE TRIGGER</code> statement. The slash is SQL*Plus's end-of-statement indicator and is not part of the statement that is run by the database.
                     </p>
                     <p>Create some sample data:</p><pre class="oac_no_warn" dir="ltr">-- Sample Data
INSERT INTO equipment (employee_id, equip_name) VALUES (100, 'pen');
INSERT INTO equipment (employee_id, equip_name) VALUES (100, 'telephone');
INSERT INTO equipment (employee_id, equip_name) VALUES (101, 'pen');
INSERT INTO equipment (employee_id, equip_name) VALUES (101, 'paper');
INSERT INTO equipment (employee_id, equip_name) VALUES (101, 'car');
INSERT INTO equipment (employee_id, equip_name) VALUES (102, 'pen');
INSERT INTO equipment (employee_id, equip_name) VALUES (102, 'paper');
INSERT INTO equipment (employee_id, equip_name) VALUES (102, 'telephone');
INSERT INTO equipment (employee_id, equip_name) VALUES (103, 'telephone');
INSERT INTO equipment (employee_id, equip_name) VALUES (103, 'computer');
INSERT INTO equipment (employee_id, equip_name) VALUES (121, 'computer');
INSERT INTO equipment (employee_id, equip_name) VALUES (180, 'pen');
INSERT INTO equipment (employee_id, equip_name) VALUES (180, 'paper');
INSERT INTO equipment (employee_id, equip_name) VALUES (180, 'cardboard box');
COMMIT;
</pre><p>In SQL*Plus create a procedure as <code class="codeph">HR</code>:
                     </p><pre class="oac_no_warn" dir="ltr">CREATE OR REPLACE PROCEDURE get_equip(eid_p IN NUMBER, RC OUT SYS_REFCURSOR) AS
BEGIN
    OPEN rc FOR SELECT   equip_name
                FROM     equipment
                WHERE    employee_id = eid_p
                ORDER BY equip_name;
END;
/
</pre><p>In PHP this procedure can be called by running an anonymous PL/SQL block:</p><pre class="oac_no_warn" dir="ltr">BEGIN get_equip(:id, :rc); END;
</pre><p>The <code class="codeph">:id</code> bind variable is used similarly to binds shown before. It passes a value from a PHP variable into the database for the <code class="codeph">WHERE</code> clause of <code class="codeph">get_equip()</code>. The bind variable <code class="codeph">:rc</code> is different and will hold the query results returned from <code class="codeph">equip_name()</code> as explained in a few moments.
                     </p>
                  </div>
                  <!-- class="section" -->
               </div>
            </div><a id="TDPPH218"></a><div class="props_rev_3"><a id="GUID-AB3E329D-786E-44FD-AD1C-5A7F56BBC776" name="GUID-AB3E329D-786E-44FD-AD1C-5A7F56BBC776"></a><h3 id="TDPPH-GUID-AB3E329D-786E-44FD-AD1C-5A7F56BBC776" class="sect3"><span class="enumeration_section">6.5 </span>Calling the REF CURSOR in PHP
               </h3>
               <div>
                  <div class="section">
                     <p>To display an employee's list of equipment create a new PHP file <code class="codeph">ac_show_equip.php</code>:
                     </p><pre class="oac_no_warn" dir="ltr">&lt;?php
 
/**
 * ac_show_equip.php: Show an employee's equipment
 * @package ShowEquipment
 */
 
session_start();
require('ac_db.inc.php');
require('ac_equip.inc.php');
 
$sess = new \Equipment\Session;
$sess-&gt;getSession();
if (!isset($sess-&gt;username) || empty($sess-&gt;username)
        || !isset($_GET['empid'])) {
    header('Location: index.php');
    exit;
}
$empid = (int) $_GET['empid'];
 
$page = new \Equipment\Page;
$page-&gt;printHeader("AnyCo Corp. Show Equipment");
$page-&gt;printMenu($sess-&gt;username, $sess-&gt;isPrivilegedUser());
printcontent($sess, $empid);
$page-&gt;printFooter();
 
// Functions
 
?&gt;
</pre><p>This is similar in structure to <code class="codeph">ac_emp_list.php</code>. This time the verification test after <code class="codeph">$sess-&gt;getSession()</code> also checks for an employee identifier. This value is passed in as a URL parameter from the <code class="codeph">printrecords()</code> function in <code class="codeph">ac_emp_list.php</code>:
                     </p><pre class="oac_no_warn" dir="ltr">...
&lt;a href='ac_show_equip.php?empid=$eid'&gt;Show&lt;/a&gt;
...
</pre><p>The identifier value is accessed in <code class="codeph">ac_show_equip.php</code> via PHP's <code class="codeph">$_GET</code> superglobal array. If the array entry is not set then the assumption is that <code class="codeph">ac_show_equip.php</code> was called incorrectly and the user is redirected to the login page, <code class="codeph">index.php</code>.
                     </p>
                     <p>The<code class="codeph"> $_GET['empid']</code> value is cast to an integer to minimize potential SQL injection issues. Although we will bind the value, it is better to consistently filter all user input. If <code class="codeph">$_GET['empid'] </code>contained alphabetic text for some reason, PHP's casting rules will result in the number <code class="codeph">0</code> being stored in <code class="codeph">$empid</code>. If the text had a numeric prefix then <code class="codeph">$empid</code> would be that number, but at least the following text would have been discarded.
                     </p>
                     <p>Before we get to the main content of the file, add a small helper function <code class="codeph">getempname()</code> in the Functions section of <code class="codeph">ac_show_equip.php</code>:
                     </p><pre class="oac_no_warn" dir="ltr">/**
 * Get an Employee Name
 *
 * @param Db $db
 * @param integer $empid
 * @return string An employee name
 */
function getempname($db, $empid) {
    $sql = "SELECT first_name || ' ' || last_name AS emp_name
        FROM employees
        WHERE employee_id = :id";
    $res = $db-&gt;execFetchAll($sql, "Get EName", array(array(":id", $empid, -1)));
    $empname = $res[0]['EMP_NAME'];
    return($empname);
}
</pre><p>This takes the employee identifier that the script was invoked for and looks up the matching employee name. An exercise for the reader is to handle the case when the query does not return any rows.</p>
                     <p>Now add the main <code class="codeph">printcontent()</code> function to <code class="codeph">ac_show_equip.php</code>:
                     </p><pre class="oac_no_warn" dir="ltr">/**
 * Print the main body of the page
 *
 * @param Session $sess
 * @param integer $empid Employee identifier
 */
function printcontent($sess, $empid) {
    echo "&lt;div id='content'&gt;\n";
    $db = new \Oracle\Db("Equipment", $sess-&gt;username);
    $empname = htmlspecialchars(getempname($db, $empid), ENT_NOQUOTES, 'UTF-8');
    echo "$empname has: ";
 
    $sql = "BEGIN get_equip(:id, :rc); END;";
    $res = $db-&gt;refcurExecFetchAll($sql, "Get Equipment List",
            "rc", array(array(":id", $empid, -1)));
    if (empty($res['EQUIP_NAME'])) {
        echo "no equipment";
    } else {
        echo "&lt;table border='1'&gt;\n";
        foreach ($res['EQUIP_NAME'] as $item) {
            $item = htmlspecialchars($item, ENT_NOQUOTES, 'UTF-8');
            echo "&lt;tr&gt;&lt;td&gt;$item&lt;/td&gt;&lt;/tr&gt;\n";
        }
        echo "&lt;/table&gt;\n";
    }
    echo "&lt;/div&gt;";  // content
}
</pre><p>This calls a new method, <code class="codeph">Db::refcurExecFetchAll()</code>, which returns an array of records, printed in a traditional loop.
                     </p>
                     <p>The <code class="codeph">REF CURSOR</code> bind parameter <code class="codeph">:rc</code> needs to be bound specially. Since the bind variable name could be arbitrarily chosen or located anywhere in the statement text, its name is passed separately into <code class="codeph">refcurExecFetchAll()</code> and it is not included in the array of normal bind variables.
                     </p>
                     <p>Now create the <code class="codeph">refcurExecFetchAll()</code> method by editing <code class="codeph">ac_db.inc.php</code> and adding this to the <code class="codeph">Db </code>class:
                     </p><pre class="oac_no_warn" dir="ltr">    /**
     * Run a call to a stored procedure that returns a REF CURSOR data
     * set in a bind variable.  The data set is fetched and returned.
     *
     * Call like Db::refcurexecfetchall("begin myproc(:rc, :p); end",
     *                            "Fetch data", ":rc", array(array(":p", $p, -1)))
     * The assumption that there is only one refcursor is an artificial
     * limitation of refcurexecfetchall()
     *
     * @param string $sql A SQL string calling a PL/SQL stored procedure
     * @param string $action Action text for End-to-End Application Tracing
     * @param string $rcname the name of the REF CURSOR bind variable
     * @param array  $otherbindvars Binds. Array (bv_name, php_variable, length)
     * @return array Returns an array of tuples
     */
    public function refcurExecFetchAll($sql, $action, $rcname, 
    $otherbindvars = array()) {
        $this-&gt;stid = oci_parse($this-&gt;conn, $sql);
        $rc = oci_new_cursor($this-&gt;conn);
        oci_bind_by_name($this-&gt;stid, $rcname, $rc, -1, OCI_B_CURSOR);
        foreach ($otherbindvars as $bv) {
            // oci_bind_by_name(resource, bv_name, php_variable, length)
            oci_bind_by_name($this-&gt;stid, $bv[0], $bv[1], $bv[2]);
        }
        oci_set_action($this-&gt;conn, $action);
        oci_execute($this-&gt;stid);
        oci_execute($rc); // run the ref cursor as if it were a statement id
        oci_fetch_all($rc, $res);	
        $this-&gt;stid = null;
        return($res);
    }
</pre><p>The <code class="codeph">REF CURSOR</code> bind parameter in <code class="codeph">$rcname</code> is bound to a cursor created with <code class="codeph">oci_new_cursor</code>(), not to a normal PHP variable. The type <code class="codeph">OCI_B_CURSOR</code> must specified.
                     </p>
                     <p>After setting the tracing "action" text, the PL/SQL statement is run. In this example it calls <code class="codeph">get_equip()</code>, which opens and returns the cursor for the query. The <code class="codeph">REF CURSOR</code> in <code class="codeph">$rc</code> can now be treated like a PHP statement identifier as if it had been returned from an <code class="codeph">oci_parse()</code> call. It is then fetched from. The query results are returned in <code class="codeph">$res</code> to the function caller.
                     </p>
                     <p>Save all files and run the application in a browser. Login as either <code class="codeph">Simon</code> or <code class="codeph">Administrator</code>. Click the <span class="bold">Show</span> link next to <span class="bold">Steven King</span>. The equipment he has is displayed: 
                     </p>
                     <div class="figure" id="GUID-AB3E329D-786E-44FD-AD1C-5A7F56BBC776__GUID-9D237893-7066-4A7D-9B92-D36EACB4BF1E"><img src="img/chap6_ref_cursor_call.png" width="493" alt="Equipments" title="Equipments"></div>
                     <!-- class="figure" -->
                  </div>
                  <!-- class="section" -->
               </div>
            </div>
         </div>
      </article>
   </body>
</html>