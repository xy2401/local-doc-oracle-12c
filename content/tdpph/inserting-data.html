<!DOCTYPE html
  SYSTEM "about:legacy-compat">

<!-- saved from url=(0023)https://docs.oracle.com -->

<html xml:lang="en-us" lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Inserting Data</title>
      <meta property="og:site_name" content="Oracle Help Center">
      <meta property="og:title" content="2 Day + PHP Developer's Guide">
      <meta property="og:description" content="">
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css">
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico">
      <meta name="application-name" content="2 Day + PHP Developer's Guide">
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)">
      <meta name="plugin" content="SP_docbuilder HTML plugin release 17.8.1">
      <link rel="alternate" href="2-day-php-developers-guide.pdf" title="PDF File" type="application/pdf">
      <meta name="robots" content="all">
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
      <meta name="dcterms.created" content="2017-10-18T11:39:07-07:00">
      <meta name="dcterms.title" content="2 Day + PHP Developer's Guide">
      <meta name="dcterms.dateCopyrighted" content="2010, 2017">
      <meta name="dcterms.category" content="database">
      <meta name="dcterms.identifier" content="E85807-01">
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/12.2">
      <meta name="dcterms.release" content="Release 12.2">
      <link rel="prev" href="query-performance-prefetching.html" title="Previous" type="text/html">
      <link rel="next" href="inserting-multiple-data-values.html" title="Next" type="text/html">
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script data-main="/sp_common/book-template/ohc-book-template/js/book-config" src="/sp_common/book-template/requirejs/require.js"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">
            {
                "primary":
                {
                    "category":{
                      "short_name":"database",
                      "element_name":"Database",
                      "display_in_url":true
                    },
                    "suite":{
                      "short_name":"oracle",
                      "element_name":"Oracle",
                      "display_in_url":true
                    },
                    "product_group":{
                      "short_name":"not-applicable",
                      "element_name":"Not applicable",
                      "display_in_url":false
                    },
                    "product":{
                      "short_name":"oracle-database",
                      "element_name":"Oracle Database",
                      "display_in_url":true
                    },
                    "release":{
                      "short_name":"12.2",
                      "element_name":"Release 12.2",
                      "display_in_url":true
                    },
                    "platform":{
                      "short_name":"",
                      "element_name":"",
                      "display_in_url":false
                    },
                    "component":{
                      "short_name":"",
                      "element_name":"",
                      "display_in_url":false
                    }
                }
            }
            </script>
      
    <meta name="dcterms.isVersionOf" content="TDPPH">
  </head>
   <body>
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="query-performance-prefetching.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>Previous</a>
         <a href="inserting-multiple-data-values.html" class="pull-right">Next<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>
         <span class="fa fa-exclamation-triangle" aria-hidden="true"></span> JavaScript must be enabled to correctly display this content
        
      </div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">2 Day + PHP Developer's Guide</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">Inserting Data</li>
            </ol>
            <a id="GUID-EFDEBBB9-84CC-4F04-8944-10238595EBE5" name="GUID-EFDEBBB9-84CC-4F04-8944-10238595EBE5"></a><a id="TDPPH173"></a>
            
            <h2 id="TDPPH-GUID-EFDEBBB9-84CC-4F04-8944-10238595EBE5" class="sect2"><span class="enumeration_chapter">9 </span>Inserting Data
            </h2>
         </header>
         <div class="ind">
            <div>
               <p>To enable pieces of equipment to be assigned to employees the AnyCo application will have an HTML form. The form allows administrators to assign a piece of equipment to a specific employee.</p>
               <p>This chapter contains the following topics:</p>
               <ul style="list-style-type: disc;">
                  <li>
                     <p><a href="inserting-data.html#GUID-08DA2A32-E616-4945-943B-B933606006DB">Building the Insert Form</a></p>
                  </li>
                  <li>
                     <p><a href="inserting-data.html#GUID-565FB7AD-DBF4-48B6-BBDC-EA7A58E5F475">Running the Single Insert Form</a></p>
                  </li>
                  <li>
                     <p><a href="inserting-data.html#GUID-3541FF1E-59E3-48BE-AD3B-1EBBD016F046">Preventing CSRF with ac_add_one.php</a></p>
                  </li>
               </ul>
            </div><a id="TDPPH174"></a><div class="props_rev_3"><a id="GUID-08DA2A32-E616-4945-943B-B933606006DB" name="GUID-08DA2A32-E616-4945-943B-B933606006DB"></a><h3 id="TDPPH-GUID-08DA2A32-E616-4945-943B-B933606006DB" class="sect3"><span class="enumeration_section">9.1 </span>Building the Insert Form
               </h3>
               <div>
                  <div class="section">
                     <p>Create a new PHP file <code class="codeph">ac_add_one.php</code>. Initially the file looks like:
                     </p><pre class="oac_no_warn" dir="ltr">&lt;?php
 
/**
 * ac_add_one.php: Add one piece of equipment to an employee
 * @package Application
 */
session_start();
require('ac_db.inc.php');
require('ac_equip.inc.php');
 
$sess = new \Equipment\Session;
$sess-&gt;getSession();
if (!isset($sess-&gt;username) || empty($sess-&gt;username)
        || !$sess-&gt;isPrivilegedUser()
        || (!isset($_GET['empid']) &amp;&amp; !isset($_POST['empid']))) {
    header('Location: index.php');
    exit;
}
$empid = (int) (isset($_GET['empid']) ? $_GET['empid'] : $_POST['empid']);
 
$page = new \Equipment\Page;
$page-&gt;printHeader("AnyCo Corp. Add Equipment");
$page-&gt;printMenu($sess-&gt;username, $sess-&gt;isPrivilegedUser());
printcontent($sess, $empid);
$page-&gt;printFooter();
 
// Functions
 
?&gt;
</pre><p>The process flow of operation will be similar to <code class="codeph">index.php</code>. The first time <code class="codeph">ac_add_one.php</code> is run an HTML input form will be displayed. When the user submits the form, <code class="codeph">ac_add_one.php</code> is invoked again, which will insert the data into the database.
                     </p>
                     <p>The privileges required by this function include checks that an employee id is set in either the <code class="codeph">$_GET['empid']</code> or <code class="codeph">$_POST['empid']</code> superglobals. When <code class="codeph">ac_add_one.php</code> is first called (see <code class="codeph">printrecords()</code> in <code class="codeph">ac_emp_list.php</code>), the employee id is passed as a URL parameter and will be in the <code class="codeph">$_GET</code> superglobal. When the form (that will shortly be shown) in <code class="codeph">ac_add_one.php</code> is submitted, the employee identifier will be in <code class="codeph">$_POST</code>.
                     </p>
                     <p>Add the <code class="codeph">printcontent()</code> function to<code class="codeph"> ac_add_one.php</code>:
                     </p><pre class="oac_no_warn" dir="ltr">/**
 * Print the main body of the page
 *
 * @param Session $sess
 * @param integer $empid Employee identifier
 */
function printcontent($sess, $empid) {
    echo "&lt;div id='content'&gt;\n";
    $db = new \Oracle\Db("Equipment", $sess-&gt;username);
    if (!isset($_POST['equip']) || empty($_POST['equip'])) {
        printform($sess, $db, $empid);
    } else {
        /* if (!isset($_POST['csrftoken'])
                || $_POST['csrftoken'] != $sess-&gt;csrftoken) {
            // the CSRF token they submitted does not match the one we sent
            header('Location: index.php');
            exit;
        } */
        $equip = getcleanequip();
        if (empty($equip)) {
            printform($sess, $db, $empid);
        } else {
            doinsert($db, $equip, $empid);
            echo "&lt;p&gt;Added new equipment&lt;/p&gt;";
            echo '&lt;a href="ac_show_equip.php?empid='
                 . $empid . '"&gt;Show Equipment&lt;/a&gt;' . "\n";
        }
    }
    echo "&lt;/div&gt;";  // content
}
</pre><p>The <code class="codeph">printcontent()</code> function contains the logic to decide if the HTML form should be printed or the user-entered data should be inserted. The commented-out CSRF token code will be discussed below.
                     </p>
                     <p>Also in <code class="codeph">ac_add_one.php</code> add the <code class="codeph">printform()</code> function:
                     </p><pre class="oac_no_warn" dir="ltr">/**
 * Print the HTML form for entering new equipment
 *
 * @param Session $sess
 * @param Db $db
 * @param integer $empid Employee identifier
 */
function printform($sess, $db, $empid) {
    $empname = htmlspecialchars(getempname($db, $empid), ENT_NOQUOTES, 'UTF-8');
    $empid = (int) $empid;
    $sess-&gt;setCsrfToken();
    echo &lt;&lt;&lt;EOF
Add equipment for $empname
&lt;form method='post' action='${_SERVER["PHP_SELF"]}'&gt;
&lt;div&gt;
    Equipment name &lt;input type="text" name="equip"&gt;&lt;br&gt;
    &lt;input type="hidden" name="empid" value="$empid"&gt;
    &lt;input type="hidden" name="csrftoken" value="$sess-&gt;csrftoken"&gt;
    &lt;input type="submit" value="Submit"&gt;
&lt;/div&gt;
&lt;/form&gt;
EOF;
}
</pre><div class="infoboxnote" id="GUID-08DA2A32-E616-4945-943B-B933606006DB__GUID-1FFE5532-BEE6-42EE-8117-31965011344B">
                        <p class="notep1">Note:</p>
                        <p>The <code class="codeph">EOF;</code>token must be at the start of a line and not have trailing white space.
                        </p>
                     </div>
                     <p>This simple form prompts the user for a value. The CSRF token will be described later.</p>
                     <p>Add the <code class="codeph">getcleanequip()</code> function to <code class="codeph">ac_add_one.php</code>:
                     </p><pre class="oac_no_warn" dir="ltr">/**
 * Perform validation and data cleaning so empty strings are not inserted
 *
 * @return string The new data to enter
 */
function getcleanequip() {
    if (!isset($_POST['equip'])) {
        return null;
    } else {
        $equip = $_POST['equip'];
        return(trim($equip));
    }
}
</pre><p>This implementation strips any leading or trailing white space from the entered data.</p>
                     <p>The general mantra for basic web application security is to filter input and escape output. The <code class="codeph">getcleanequip()</code> function filters input. The data could be sanitized in other ways here. You may decide that you do not want HTML tags to be accepted. You can strip such tags by using one of PHP's input filters. For example, if you wanted, you could change:
                     </p><pre class="oac_no_warn" dir="ltr">        $equip = $_POST['equip'];
</pre><p>to</p><pre class="oac_no_warn" dir="ltr">        $equip = filter_input(INPUT_POST, 'equip', FILTER_SANITIZE_STRING);
</pre><p>This would remove HTML tags, leaving other text in place.</p>
                     <p>In <code class="codeph">ac_add_one.php</code>, valid data is inserted by <code class="codeph">doinsert()</code>. Add the code for this function to the file:
                     </p><pre class="oac_no_warn" dir="ltr">/**
 * Insert a piece of equipment for an employee
 *
 * @param Db $db
 * @param string $equip Name of equipment to insert
 * @param string $empid Employee identifier
 */
function doinsert($db, $equip, $empid) {
    $sql = "INSERT INTO equipment (employee_id, equip_name) VALUES (:ei, :nm)";
    $db-&gt;execute($sql, "Insert Equipment", array(array("ei", $empid, -1),
                                                 array("nm", $equip, -1)));
}
</pre><p>This uses the existing <code class="codeph">Db::execute()</code> method in <code class="codeph">ac_db.inc.php</code> with familiar bind variable syntax. Note that the <code class="codeph">Db</code> class automatically commits each time <code class="codeph">oci_execute()</code> is called as discussed earlier in the section <a href="building-database-access-class.html#GUID-0082911D-ECDB-4EF1-83BF-430DAF3C7A40">Running SQL with the Db Class</a>.
                     </p>
                     <p>Finally, to complete <code class="codeph">ac_add_one.php</code>, add the helper function <code class="codeph">getempname()</code>:
                     </p><pre class="oac_no_warn" dir="ltr">/**
 * Get an Employee Name
 *
 * @param Db $db
 * @param integer $empid
 * @return string An employee name
 */
function getempname($db, $empid) {
    $sql = "SELECT first_name || ' ' || last_name AS emp_name
        FROM employees
        WHERE employee_id = :id";
    $res = $db-&gt;execFetchAll($sql, "Get EName", array(array("id", $empid, -1)));
    $empname = $res[0]['EMP_NAME'];
    return($empname);
}
</pre><p>This is identical to the function of the same name in <code class="codeph">ac_show_equip.php</code>.
                     </p>
                     <p>Similar functionality to the <code class="codeph">ac_show_equip.php</code> form could be used to delete or update records, remembering the limitations of a stateless web architecture means that rows cannot be locked in one HTML page and changed in another.
                     </p>
                  </div>
                  <!-- class="section" -->
               </div>
            </div><a id="TDPPH175"></a><div class="props_rev_3"><a id="GUID-565FB7AD-DBF4-48B6-BBDC-EA7A58E5F475" name="GUID-565FB7AD-DBF4-48B6-BBDC-EA7A58E5F475"></a><h3 id="TDPPH-GUID-565FB7AD-DBF4-48B6-BBDC-EA7A58E5F475" class="sect3"><span class="enumeration_section">9.2 </span>Running the Single Insert Form
               </h3>
               <div>
                  <div class="section">
                     <p>Run the AnyCo application and log in as <code class="codeph">Administrator</code>. Click the <span class="bold">Add One</span> link next to Steven King. The equipment input form is displayed:
                     </p>
                     <div class="figure" id="GUID-565FB7AD-DBF4-48B6-BBDC-EA7A58E5F475__GUID-DE2CC490-A751-4FB2-A2FB-7C9381F8466E"><img width="474" src="img/chap9_insert.png" alt="Insert Form" title="Insert Form"></div>
                     <!-- class="figure" -->
                     <p>Enter a new piece of equipment, <code class="codeph">paper</code>, and click <span class="bold">Submit</span>. The new data is inserted. The updated list can be seen by clicking <span class="bold">Show</span> link next to Steven King.
                     </p>
                     <div class="figure" id="GUID-565FB7AD-DBF4-48B6-BBDC-EA7A58E5F475__GUID-790FEEF1-38ED-4054-9685-2D57EDD9A99E"><img width="474" src="img/chap9_paper.png" alt="Show Equipment" title="Show Equipment"></div>
                     <!-- class="figure" -->
                  </div>
                  <!-- class="section" -->
               </div>
            </div><a id="TDPPH176"></a><div class="props_rev_3"><a id="GUID-3541FF1E-59E3-48BE-AD3B-1EBBD016F046" name="GUID-3541FF1E-59E3-48BE-AD3B-1EBBD016F046"></a><h3 id="TDPPH-GUID-3541FF1E-59E3-48BE-AD3B-1EBBD016F046" class="sect3"><span class="enumeration_section">9.3 </span>Preventing CSRF with ac_add_one.php
               </h3>
               <div>
                  <div class="section">
                     <p>The form is currently prone to cross-site request forgery (CSRF) attacks, where another site can take advantage of you being logged in and cause you to submit data or do some other privileged operation.</p>
                     <p>To show this, create a new HTML page called <code class="codeph">hack.html</code>:
                     </p><pre class="oac_no_warn" dir="ltr">&lt;html&gt;
&lt;!-- hack.html: Show issues with CSRF --&gt;
&lt;body&gt;
&lt;h1&gt;Make Millions!&lt;/h1&gt;
&lt;form method='post' action='http://localhost/ac_add_one.php'&gt;
&lt;div&gt;
    Do you dream of being rich?&lt;br&gt;
    &lt;input type="hidden" name="equip" value="fish"&gt;
    &lt;input type="hidden" name="empid" value="100"&gt;
    &lt;input type="submit" value="Win"&gt;
&lt;/div&gt;
&lt;/form&gt;
 
&lt;/body&gt;
&lt;/html&gt;
</pre><p>Change the HTML form action URL to match your system.</p>
                     <p>Run the AnyCo application in a browser and login as <code class="codeph">Administrator</code>. In a new browser tab or window, open the following file:
                     </p>
                     <p><code class="codeph">http://localhost/hack.html</code></p>
                     <p>Ostensibly to the person looking at the page it has nothing to do with the AnyCo application. </p>
                     <div class="figure" id="GUID-3541FF1E-59E3-48BE-AD3B-1EBBD016F046__GUID-353C8573-B563-4304-9630-2292E252F4BA"><img width="153" src="img/chap9_csrf_ac_add_1.png" alt="CSRF" title="CSRF"></div>
                     <!-- class="figure" -->
                     <p>Click the <span class="bold">Win</span> button. This calls the AnyCo application and causes the bogus equipment name <code class="codeph">fish</code> to be inserted into the equipment list of employee <code class="codeph">100</code> (which is Steven King). The inserted value can be seen on the subsequent <span class="bold">Show Equipment</span> page:
                     </p>
                     <div class="figure" id="GUID-3541FF1E-59E3-48BE-AD3B-1EBBD016F046__GUID-E6FE3E94-563B-44EA-8A24-2B04D3693FE7"><img width="474" src="img/chap9_fish.png" alt="Show Equipment result with the entry fish" title="Show Equipment result with the entry fish"></div>
                     <!-- class="figure" -->
                     <p>Now edit <code class="codeph">ac_add_one.php</code> and enable CSRF protection by removing the comments for the check in <code class="codeph">printcontent()</code>:
                     </p><pre class="oac_no_warn" dir="ltr">    ...
    } else {
        <span class="bold">if (!isset($_POST['csrftoken'])</span>
                <span class="bold">|| $_POST['csrftoken'] != $sess-&gt;csrftoken) {</span>
            <span class="bold">// the CSRF token they submitted does not match the one we sent</span>
            <span class="bold">header('Location: index.php');</span>
            <span class="bold">exit;</span>
        <span class="bold">}</span>
        $equip = getcleanequip();
     ...
</pre><p>The form in <code class="codeph">ac_add_one.php</code> includes a generated Cross-Site Request Forgery token as a hidden field. The value is also stored in the user session. The CSRF check in <code class="codeph">printcontent()</code> will verify that the token in the submitted form matches PHP's stored session value.
                     </p>
                     <p>Save the file and run the AnyCo application again, logging in as <code class="codeph">Administrator</code>. In a new browser tab or window, open the following file:
                     </p>
                     <p><code class="codeph">http://localhost/hack.html</code></p>
                     <p>Now click <span class="bold">Win</span>.
                     </p>
                     <p>This time the CSRF protection in <code class="codeph">printcontent()</code> does not find a CSRF token in the submitted form and redirects to the login page, index.php, which logs out. Log back in again to the AnyCo application and check that Steven King's equipment list is unchanged, with no second entry for <code class="codeph">fish</code>. For hack.html to be successful it would have to know the value of the <code class="codeph">csrftoken</code> field that gets stored in the PHP session when the <code class="codeph">ac_add_one.php</code> generates the real entry form.
                     </p>
                     <p>CSRF protection is just one of many kinds of security restrictions that web applications should enforce. You should do a thorough security evaluation of any code you deploy on the web.</p>
                     <p>Many of the popular PHP frameworks provide assistance to reduce the amount of effort required in producing a secure application. For example they may provide a more secure implementation of CSRF token generation than the one in the AnyCo Session class.</p>
                  </div>
                  <!-- class="section" -->
               </div>
            </div>
         </div>
      </article>
   </body>
</html>