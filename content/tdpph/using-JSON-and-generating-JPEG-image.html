<!DOCTYPE html
  SYSTEM "about:legacy-compat">

<!-- saved from url=(0023)https://docs.oracle.com -->

<html xml:lang="en-us" lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Using JSON and Generating a JPEG Image</title>
      <meta property="og:site_name" content="Oracle Help Center">
      <meta property="og:title" content="2 Day + PHP Developer's Guide">
      <meta property="og:description" content="">
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css">
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico">
      <meta name="application-name" content="2 Day + PHP Developer's Guide">
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)">
      <meta name="plugin" content="SP_docbuilder HTML plugin release 17.8.1">
      <link rel="alternate" href="2-day-php-developers-guide.pdf" title="PDF File" type="application/pdf">
      <meta name="robots" content="all">
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
      <meta name="dcterms.created" content="2017-10-18T11:39:07-07:00">
      <meta name="dcterms.title" content="2 Day + PHP Developer's Guide">
      <meta name="dcterms.dateCopyrighted" content="2010, 2017">
      <meta name="dcterms.category" content="database">
      <meta name="dcterms.identifier" content="E85807-01">
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/12.2">
      <meta name="dcterms.release" content="Release 12.2">
      <link rel="prev" href="inserting-multiple-data-values.html" title="Previous" type="text/html">
      <link rel="next" href="uploading-and-displaying-BLOBs.html" title="Next" type="text/html">
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script data-main="/sp_common/book-template/ohc-book-template/js/book-config" src="/sp_common/book-template/requirejs/require.js"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">
            {
                "primary":
                {
                    "category":{
                      "short_name":"database",
                      "element_name":"Database",
                      "display_in_url":true
                    },
                    "suite":{
                      "short_name":"oracle",
                      "element_name":"Oracle",
                      "display_in_url":true
                    },
                    "product_group":{
                      "short_name":"not-applicable",
                      "element_name":"Not applicable",
                      "display_in_url":false
                    },
                    "product":{
                      "short_name":"oracle-database",
                      "element_name":"Oracle Database",
                      "display_in_url":true
                    },
                    "release":{
                      "short_name":"12.2",
                      "element_name":"Release 12.2",
                      "display_in_url":true
                    },
                    "platform":{
                      "short_name":"",
                      "element_name":"",
                      "display_in_url":false
                    },
                    "component":{
                      "short_name":"",
                      "element_name":"",
                      "display_in_url":false
                    }
                }
            }
            </script>
      
    <meta name="dcterms.isVersionOf" content="TDPPH">
  </head>
   <body>
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="inserting-multiple-data-values.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>Previous</a>
         <a href="uploading-and-displaying-BLOBs.html" class="pull-right">Next<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>
         <span class="fa fa-exclamation-triangle" aria-hidden="true"></span> JavaScript must be enabled to correctly display this content
        
      </div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">2 Day + PHP Developer's Guide</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">Using JSON and Generating a JPEG Image</li>
            </ol>
            <a id="GUID-58DE9C33-B840-4E22-97E5-F0DA11007946" name="GUID-58DE9C33-B840-4E22-97E5-F0DA11007946"></a><a id="TDPPH180"></a>
            
            <h2 id="TDPPH-GUID-58DE9C33-B840-4E22-97E5-F0DA11007946" class="sect2"><span class="enumeration_chapter">11 </span>Using JSON and Generating a JPEG Image
            </h2>
         </header>
         <div class="ind">
            <div>
               <p>This chapter shows how the JSON serialization format can be used for transferring data from a simple web service. The web service is called by a client that creates an image using PHP's GD extension.</p>
               <p>This chapter contains the following topics:</p>
               <ul style="list-style-type: disc;">
                  <li>
                     <p><a href="using-JSON-and-generating-JPEG-image.html#GUID-ABF34944-B38C-49C4-BC45-02EFD1995487">Creating a Simple Web Service Returning JSON</a></p>
                  </li>
                  <li>
                     <p><a href="using-JSON-and-generating-JPEG-image.html#GUID-547B1D82-9C3F-4E7A-B4F0-853D92CF641E">Creating a JPEG image</a></p>
                  </li>
               </ul>
            </div><a id="TDPPH181"></a><div class="props_rev_3"><a id="GUID-ABF34944-B38C-49C4-BC45-02EFD1995487" name="GUID-ABF34944-B38C-49C4-BC45-02EFD1995487"></a><h3 id="TDPPH-GUID-ABF34944-B38C-49C4-BC45-02EFD1995487" class="sect3"><span class="enumeration_section">11.1 </span>Creating a Simple Web Service Returning JSON
               </h3>
               <div>
                  <div class="section">
                     <p>Create a new PHP file <code class="codeph">ac_get_json.php</code> containing:
                     </p><pre class="oac_no_warn" dir="ltr">&lt;?php
 
/**
 * ac_get_json.php: Service returning equipment counts in JSON
 * @package WebService
 */
 
require('ac_db.inc.php');
 
if (!isset($_POST['username'])) {
    header('Location: index.php');
    exit;
}
 
$db = new \Oracle\Db("Equipment", $_POST['username']);
 
$sql = "select equip_name, count(equip_name) as cn
        from equipment
        group by equip_name";
$res = $db-&gt;execFetchAll($sql, "Get Equipment Counts");
 
$mydata = array();
foreach ($res as $row) {
    $mydata[$row['EQUIP_NAME']] = (int) $row['CN'];
}
 
echo json_encode($mydata);
 
?&gt;
</pre><p>Note there is no authentication in this web service. It is "external" to the AnyCo application. All it requires is a <code class="codeph">username</code> entry in the <code class="codeph">POST</code> data.
                     </p>
                     <p>The file queries the AnyCo Corp. equipment allocation and uses PHP's <code class="codeph">json_encode()</code> to return the statistics in JSON format. The output returned by the web service is something like this, depending on which data you currently have in the <code class="codeph">EQUIPMENT</code> table:
                     </p><pre class="oac_no_warn" dir="ltr">{"cardboard box":1,"pen":4,"computer":2,"telephone":3,"paper":3,"car":1}
</pre></div>
                  <!-- class="section" -->
               </div>
            </div><a id="TDPPH182"></a><div class="props_rev_3"><a id="GUID-547B1D82-9C3F-4E7A-B4F0-853D92CF641E" name="GUID-547B1D82-9C3F-4E7A-B4F0-853D92CF641E"></a><h3 id="TDPPH-GUID-547B1D82-9C3F-4E7A-B4F0-853D92CF641E" class="sect3"><span class="enumeration_section">11.2 </span>Creating a JPEG image
               </h3>
               <div>
                  <div class="section">
                     <p>Create a new PHP file <code class="codeph">ac_graph_img.php</code> to call the web service and create a graph. The file initially contains:
                     </p><pre class="oac_no_warn" dir="ltr">&lt;?php
 
/**
 * ac_graph_img.php: Create a JPEG image of the equipment allocation statistics
 *
 * do not have any text or white space before the "&lt;?php" tag because it will
 * be incorporated into the image stream and corrupt the picture.
 *
 * @package Graph
 */
 
define('WEB_SERVICE_URL', "http://localhost/ac_get_json.php");
 
session_start();
require('ac_equip.inc.php');
 
$sess = new \Equipment\Session;
$sess-&gt;getSession();
if (!isset($sess-&gt;username) || empty($sess-&gt;username)
    || !$sess-&gt;isPrivilegedUser()) {
    header('Location: index.php');
    exit;
}
$data = callservice($sess);
do_graph("Equipment Count", 600, $data);
 
// Functions
 
?&gt;
</pre><p>Change the web service URL to match your system.</p>
                     <p>To this file add the <code class="codeph">callservice()</code> function:
                     </p><pre class="oac_no_warn" dir="ltr">/**
 * Call the service and return its results
 *
 * @param Session $sess
 * @return array Equipment name/count array
 */
function callservice($sess) {
    // Call the web "service" to get the Equipment statistics
    // Change the URL to match your system configuration
    $calldata = array('username' =&gt; $sess-&gt;username);
    $options = array(
        'http' =&gt; array(
            'method'  =&gt; 'POST',
            'header'  =&gt; 'Content-type: application/x-www-form-urlencoded',
            'content' =&gt; http_build_query($calldata)
        )
    );
    $ctx = stream_context_create($options);
    $result = file_get_contents(WEB_SERVICE_URL, false, $ctx);
    if (!$result) {
        $data = null;
    } else {
        $data = json_decode($result, true);
 
        // Sort an array by keys using an anonymous function
        uksort($data, function($a, $b) {
            if ($a == $b)
                return 0;
            else
                return ($a &lt; $b) ? -1 : 1;
            });
        }
    return($data);
}
</pre><p>This uses the PHP streams functionality to request the URL and get the statistics. The stream context includes the <code class="codeph">username</code> as a post variable, which is required by the service.
                     </p>
                     <p>The data is decoded from the JSON format and the array is sorted by name order. The second argument to PHP's <code class="codeph">uksort()</code> function is an anonymous function that does the data comparison.
                     </p>
                     <p>Edit ac_graph_img.php and add the function to create the image:</p><pre class="oac_no_warn" dir="ltr">/**
 * Draw a bar graph, with bars projecting horizontally
 *
 * @param string $title The Graph's title
 * @param type $width Desired image width in pixels
 * @param array $items Array of (caption, value) tuples
 */
function do_graph($title, $width, $items) {
    $border = 50;             // border space around bars
    $caption_gap = 4;         // space between bar and its caption
    $bar_width = 20;          // width of each bar
    $bar_gap = 40;            // space between each bar
    $title_font_id = 5;       // font id for the main title
    $bar_caption_font_id = 5; // font id for each bar's title
 
    // Image height depends on the number of items
    $height = (2 * $border) + (count($items) * $bar_width) +
        ((count($items) - 1) * $bar_gap);
 
    // Find the horizontal distance unit for one item
    $unit = ($width - (2 * $border)) / max($items);
 
    // Create the image and add the title
    $im = ImageCreate($width, $height);
    if (!$im) {
        trigger_error("Cannot create image&lt;br&gt;\n", E_USER_ERROR);
    }
    $background_col = ImageColorAllocate($im, 255, 255, 255); // white
    $bar_col = ImageColorAllocate($im, 0, 64, 128);           // blue
    $letter_col = ImageColorAllocate($im, 0, 0, 0);           // black
    ImageFilledRectangle($im, 0, 0, $width, $height, $background_col);
    ImageString($im, $title_font_id, $border, 4, $title, $letter_col);

    // Draw each bar and add a caption
    $start_y = $border;
    foreach ($items as $caption =&gt; $value) {
        $end_x = $border + ($value * $unit);
        $end_y = $start_y + $bar_width;
        ImageFilledRectangle($im, $border, $start_y, $end_x, $end_y, $bar_col);
        ImageString($im, $bar_caption_font_id, $border,
            $start_y + $bar_width + $caption_gap, $caption, $letter_col);
        $start_y = $start_y + ($bar_width + $bar_gap);
    }
 
    // Output the complete image.
    // Any text, error message or even white space that appears before this
    // (including any white space before the "&lt;?php" tag) will corrupt the
    // image data.  Comment out the "header" line to debug any issues.
    header("Content-type: image/jpg");
    ImageJpeg($im);
    ImageDestroy($im);
}
</pre><p>This function uses PHP's GD extension to create the graph. The default GD fonts are a bit clunky but new ones can be added. The output is a JPEG stream so the PHP file can be called anywhere in a web page's HTML code where you would otherwise include an image file.</p>
                     <p>In the AnyCo application, the image can be integrated by creating a new file <code class="codeph">ac_graph_page.php</code>:
                     </p><pre class="oac_no_warn" dir="ltr">&lt;?php
 
/**
 * ac_graph_page.php: Display a page containing the equipment graph
 * @package Graph
 */
 
session_start();
require('ac_equip.inc.php');
 
$sess = new \Equipment\Session;
$sess-&gt;getSession();
if (!isset($sess-&gt;username) || empty($sess-&gt;username)
         || !$sess-&gt;isPrivilegedUser()) {
    header('Location: index.php');
    exit;
}
 
$page = new \Equipment\Page;
$page-&gt;printHeader("AnyCo Corp. Equipment Graph");
$page-&gt;printMenu($sess-&gt;username, $sess-&gt;isPrivilegedUser());
 
echo &lt;&lt;&lt;EOF
&lt;div id='content'&gt;
&lt;img src='ac_graph_img.php' alt='Graph of office equipment'&gt;
&lt;/div&gt;
EOF;
 
$page-&gt;printFooter();
 
?&gt;
</pre><div class="infoboxnote" id="GUID-547B1D82-9C3F-4E7A-B4F0-853D92CF641E__GUID-9ABBD109-4388-4C4C-A376-57264D948D08">
                        <p class="notep1">Note:</p>
                        <p>The <code class="codeph">EOF;</code> token must be at the start of a line and not have trailing white space.
                        </p>
                     </div>
                     <p>The image is included in a normal HTML <code class="codeph">img</code> tag.
                     </p>
                     <p>Load the AnyCo application in a browser and log in as <code class="codeph">Administrator</code>. Click the <span class="bold">Equipment Graph</span> link in the left hand navigation menu. The graph is displayed.
                     </p>
                     <div class="figure" id="GUID-547B1D82-9C3F-4E7A-B4F0-853D92CF641E__GUID-16FCBC2D-887D-406F-9A77-DADA1F51485C"><img width="520" src="img/chap11_jpeg_image.png" alt="JPEG Image for Equipment Graph" title="JPEG Image for Equipment Graph"></div>
                     <!-- class="figure" -->
                     <p>If the image does not display, it might be a problem in <code class="codeph">ac_graph_img.php</code> due to text such as an error message or even because of white space before the <code class="codeph">&lt;?php</code> tag. This text will be included in the image stream and make the picture invalid. To help debug this kind of problem you could comment out the <code class="codeph">$session</code> checks and also the <code class="codeph">header() </code>call in <code class="codeph">ac_graph_img.php</code>. Then to show the raw data of the image stream load the following link in a browser:
                     </p>
                     <p><code class="codeph">http://localhost/ac_graph_img.php</code></p>
                     <p>The JSON format is often used to efficiently transfer data between a browser and a PHP server. The <code class="codeph">ac_get_json.php</code> web service could be used directly in many of the available JSON graphics libraries.
                     </p>
                  </div>
                  <!-- class="section" -->
               </div>
            </div>
         </div>
      </article>
   </body>
</html>