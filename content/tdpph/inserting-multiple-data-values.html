<!DOCTYPE html
  SYSTEM "about:legacy-compat">

<!-- saved from url=(0023)https://docs.oracle.com -->

<html xml:lang="en-us" lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Inserting Multiple Data Values</title>
      <meta property="og:site_name" content="Oracle Help Center">
      <meta property="og:title" content="2 Day + PHP Developer's Guide">
      <meta property="og:description" content="">
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css">
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico">
      <meta name="application-name" content="2 Day + PHP Developer's Guide">
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)">
      <meta name="plugin" content="SP_docbuilder HTML plugin release 17.8.1">
      <link rel="alternate" href="2-day-php-developers-guide.pdf" title="PDF File" type="application/pdf">
      <meta name="robots" content="all">
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
      <meta name="dcterms.created" content="2017-10-18T11:39:07-07:00">
      <meta name="dcterms.title" content="2 Day + PHP Developer's Guide">
      <meta name="dcterms.dateCopyrighted" content="2010, 2017">
      <meta name="dcterms.category" content="database">
      <meta name="dcterms.identifier" content="E85807-01">
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/12.2">
      <meta name="dcterms.release" content="Release 12.2">
      <link rel="prev" href="inserting-data.html" title="Previous" type="text/html">
      <link rel="next" href="using-JSON-and-generating-JPEG-image.html" title="Next" type="text/html">
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script data-main="/sp_common/book-template/ohc-book-template/js/book-config" src="/sp_common/book-template/requirejs/require.js"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">
            {
                "primary":
                {
                    "category":{
                      "short_name":"database",
                      "element_name":"Database",
                      "display_in_url":true
                    },
                    "suite":{
                      "short_name":"oracle",
                      "element_name":"Oracle",
                      "display_in_url":true
                    },
                    "product_group":{
                      "short_name":"not-applicable",
                      "element_name":"Not applicable",
                      "display_in_url":false
                    },
                    "product":{
                      "short_name":"oracle-database",
                      "element_name":"Oracle Database",
                      "display_in_url":true
                    },
                    "release":{
                      "short_name":"12.2",
                      "element_name":"Release 12.2",
                      "display_in_url":true
                    },
                    "platform":{
                      "short_name":"",
                      "element_name":"",
                      "display_in_url":false
                    },
                    "component":{
                      "short_name":"",
                      "element_name":"",
                      "display_in_url":false
                    }
                }
            }
            </script>
      
    <meta name="dcterms.isVersionOf" content="TDPPH">
  </head>
   <body>
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="inserting-data.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>Previous</a>
         <a href="using-JSON-and-generating-JPEG-image.html" class="pull-right">Next<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>
         <span class="fa fa-exclamation-triangle" aria-hidden="true"></span> JavaScript must be enabled to correctly display this content
        
      </div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">2 Day + PHP Developer's Guide</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">Inserting Multiple Data Values </li>
            </ol>
            <a id="GUID-B37F8005-EE4F-460A-AECF-A9D7FCBEDB35" name="GUID-B37F8005-EE4F-460A-AECF-A9D7FCBEDB35"></a><a id="TDPPH177"></a>
            
            <h2 id="TDPPH-GUID-B37F8005-EE4F-460A-AECF-A9D7FCBEDB35" class="sect2"><span class="enumeration_chapter">10 </span>Inserting Multiple Data Values 
            </h2>
         </header>
         <div class="ind">
            <div>
               <p>PHP OCI8 can insert arrays of characters or integers in one call. This reduces network traffic and database system overhead when inserting multiple values into a table.</p>
               <p>This chapter contains the following topics:</p>
               <ul style="list-style-type: disc;">
                  <li>
                     <p><a href="inserting-multiple-data-values.html#GUID-FE2C978D-1223-445D-BDE2-DEF645997050">Creating the Multiple Insert Form</a></p>
                  </li>
                  <li>
                     <p><a href="inserting-multiple-data-values.html#GUID-91D78152-5BD0-4370-BED4-5B138AB8BB64"> Running the Multiple Insert Form</a></p>
                  </li>
               </ul>
            </div><a id="TDPPH178"></a><div class="props_rev_3"><a id="GUID-FE2C978D-1223-445D-BDE2-DEF645997050" name="GUID-FE2C978D-1223-445D-BDE2-DEF645997050"></a><h3 id="TDPPH-GUID-FE2C978D-1223-445D-BDE2-DEF645997050" class="sect3"><span class="enumeration_section">10.1 </span>Creating the Multiple Insert Form
               </h3>
               <div>
                  <div class="section">
                     <p>The example in this chapter shows a form allowing three data values to be inserted in one operation.</p>
                     <p>The array insert is done using a PL/SQL bulk <code class="codeph">FORALL</code> command. Login to SQL*Plus as <code class="codeph">HR</code> and create a PL/SQL package:
                     </p><pre class="oac_no_warn" dir="ltr">CREATE OR REPLACE PACKAGE equip_pkg AS
    TYPE arrtype IS TABLE OF VARCHAR2(20) INDEX BY PLS_INTEGER;
    PROCEDURE insert_equip(eid_p IN NUMBER, eqa_p IN arrtype);
END equip_pkg;
/
</pre><pre class="oac_no_warn" dir="ltr">CREATE OR REPLACE PACKAGE BODY equip_pkg AS
    PROCEDURE insert_equip(eid_p IN NUMBER, eqa_p IN arrtype) IS
    BEGIN
        FORALL i IN INDICES OF eqa_p
            INSERT INTO equipment (employee_id, equip_name) 
                                   VALUES (eid_p, eqa_p(i));
    END insert_equip;
END equip_pkg;
/</pre><div class="infoboxnote" id="GUID-FE2C978D-1223-445D-BDE2-DEF645997050__GUID-7A1C522F-5877-4CA7-A64B-643295D186C0">
                        <p class="notep1">Note:</p>
                        <p>The "/" tokens are needed only in SQL*Plus.</p>
                     </div>
                     <p>The <code class="codeph">insert_equip()</code> procedure accepts an array of equipment names and inserts them in to the <code class="codeph">EQUIPMENT</code> table.
                     </p>
                     <p>Create a new PHP file <code class="codeph">ac_add_multi.php</code> and copy the contents of <code class="codeph">ac_add_one.php</code> to it. Carefully make the following changes to convert it to handle an array of values.
                     </p>
                     <p>In the HTML form in <code class="codeph">ac_add_multi.php</code>, change the one input field from:
                     </p><pre class="oac_no_warn" dir="ltr">&lt;div&gt;
    Equipment name &lt;input type="text" name="equip"&gt;&lt;br&gt;
    &lt;input type="hidden" name="empid" value="$empid"&gt;
...
</pre><p>to three input fields:</p><pre class="oac_no_warn" dir="ltr">...
&lt;div&gt;
    Equipment name &lt;input type="text" name="equip[]"&gt;&lt;br&gt;
    Equipment name &lt;input type="text" name="equip[]"&gt;&lt;br&gt;
    Equipment name &lt;input type="text" name="equip[]"&gt;&lt;br&gt;
    &lt;input type="hidden" name="empid" value="$empid"&gt;
...
</pre><p>Note the <code class="codeph">[]</code> tokens to return an array, which were not needed in <code class="codeph">ac_add_one.php</code>.
                     </p>
                     <p>Replace the <code class="codeph">getcleanequip()</code> function in <code class="codeph">ac_add_multi.php</code> so it handles the array of returned form values:
                     </p><pre class="oac_no_warn" dir="ltr">/**
 * Perform validation and data cleaning so empty strings are not inserted
 *
 * @return array The array of new data to enter
 */
function getcleanequip() {
    if (!isset($_POST['equip'])) {
        return array();
    } else {
        $equiparr = array();
        foreach ($_POST['equip'] as $v) {     // Strip out unset values
            $v = trim($v);
            if (!empty($v))
                $equiparr[] = $v;
        }
        return($equiparr);
    }
}
</pre><p>This loops along each of the array entries and only returns non empty strings.</p>
                     <p>Finally, replace <code class="codeph">doinsert()</code> in <code class="codeph">ac_add_multi.php</code> with:
                     </p><pre class="oac_no_warn" dir="ltr">/**
 * Insert an array of equipment values for an employee
 *
 * @param Db $db
 * @param array $equiparr array of string values to be inserted
 * @param string $empid Employee identifier
 */
function doinsert($db, $equiparr, $empid) {
    $arraybinds = array(array("eqa", $equiparr, SQLT_CHR));
    $otherbinds = array(array("eid", $empid, -1));
    $sql = "BEGIN equip_pkg.insert_equip(:eid, :eqa); END;";
    $db-&gt;arrayInsert($sql, "Insert Equipment List", $arraybinds, $otherbinds);
}
</pre><p>This uses a new <code class="codeph">arrayInsert()</code> method in the <code class="codeph">Db </code>class to call the PL/SQL <code class="codeph">insert_equip()</code> procedure. The data value arrays needs to be bound differently from normal scalar PHP OCI8 binds, so the bind parameters to <code class="codeph">arrayInsert()</code> are separated into two kinds.
                     </p>
                     <p>Edit ac_db.inc.php and add the new method:</p><pre class="oac_no_warn" dir="ltr">    /**
     * Insert an array of values by calling a PL/SQL procedure
     *
     * Call like Db::arrayinsert("begin myproc(:arn, :p); end",
     *                               "Insert stuff",
     *                               array(array(":arn", $dataarray, SQLT_CHR)),
     *                               array(array(":p", $p, -1)))
     *
     * @param string $sql PL/SQL anonymous block
     * @param string $action Action text for End-to-End Application Tracing
     * @param array $arraybindvars Bind variables. An array of tuples
     * @param array $otherbindvars  Bind variables. An array of tuples
     */
    public function arrayInsert($sql, $action, $arraybindvars, 
    $otherbindvars = array()) {
        $this-&gt;stid = oci_parse($this-&gt;conn, $sql);
        foreach ($arraybindvars as $a) {
            // oci_bind_array_by_name(resource, bv_name, 
            // php_array, php_array_length, max_item_length, datatype)
            oci_bind_array_by_name($this-&gt;stid, $a[0], $a[1], 
            count($a[1]), -1, $a[2]);
        }
        foreach ($otherbindvars as $bv) {
            // oci_bind_by_name(resource, bv_name, php_variable, length)
            oci_bind_by_name($this-&gt;stid, $bv[0], $bv[1], $bv[2]);
        }
        oci_set_action($this-&gt;conn, $action);
        oci_execute($this-&gt;stid);              // will auto commit
        	$this-&gt;stid = null;
    }
</pre><p>Binding in <code class="codeph">Db::arrayInsert()</code> is similar to the example previously shown in this manual. The <code class="codeph">oci_bind_array_by_name()</code> function takes slightly different arguments, since the number of elements in data array must now be passed in. In the AnyCo application <code class="codeph">oci_bind_array_by_name</code> is being used only for inserting data from PHP so the maximum data length parameter can be passed as <code class="codeph">-1</code>. This tells PHP to use the actual value lengths. The single <code class="codeph">oci_execute()</code> call inserts all the data items into the database.
                     </p>
                  </div>
                  <!-- class="section" -->
               </div>
            </div><a id="TDPPH179"></a><div class="props_rev_3"><a id="GUID-91D78152-5BD0-4370-BED4-5B138AB8BB64" name="GUID-91D78152-5BD0-4370-BED4-5B138AB8BB64"></a><h3 id="TDPPH-GUID-91D78152-5BD0-4370-BED4-5B138AB8BB64" class="sect3"><span class="enumeration_section">10.2 </span>Running the Multiple Insert Form
               </h3>
               <div>
                  <div class="section">
                     <p>Save the files and run the AnyCo application in a browser. Log in as <code class="codeph">Administrator</code> and click the <span class="bold">Add Multiple</span> link for Steven King.
                     </p>
                     <div class="figure" id="GUID-91D78152-5BD0-4370-BED4-5B138AB8BB64__GUID-8BA8BB90-BBA0-4701-86AF-EF3F2BD519BA"><img src="img/chap1_overview.png" width="493" alt="Employee list with Add Multiple link" title="Employee list with Add Multiple link"></div>
                     <!-- class="figure" -->
                     <p>Add some data items such as <code class="codeph">Computer</code>, <code class="codeph">Monitor</code>, and <code class="codeph">Keyboard</code>.
                     </p>
                     <div class="figure" id="GUID-91D78152-5BD0-4370-BED4-5B138AB8BB64__GUID-052CC7F8-ADE1-49C3-8A1C-2844265FAD2B"><img src="img/chap10_multiple_insert.png" width="480" alt="The multiple insert form" title="The multiple insert form"></div>
                     <!-- class="figure" -->
                     <p>Click <span class="bold">Submit</span> and then click <span class="bold">Show</span> next to Steven King to check that the data items are inserted.
                     </p>
                     <div class="figure" id="GUID-91D78152-5BD0-4370-BED4-5B138AB8BB64__GUID-63D2A19B-86F8-4221-9549-DA720E1E0610"><img src="img/chap10_multiple.png" width="474" alt="Multiple entry" title="Multiple entry"></div>
                     <!-- class="figure" -->
                     <p>Array binding also works for fetching data. PL/SQL procedures using the efficient <code class="codeph">BULK COLLECT</code> syntax can return data to PHP in one OCI8 <code class="codeph">oci_execute()</code> call. For retrieving data from Oracle the <code class="codeph">oci_bind_array_by_name()</code> call would need to know how many items and what the maximum data size is so PHP can allocate the memory correctly.
                     </p>
                  </div>
                  <!-- class="section" -->
               </div>
            </div>
         </div>
      </article>
   </body>
</html>