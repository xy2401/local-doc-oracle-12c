<!DOCTYPE html
  SYSTEM "about:legacy-compat">

<!-- saved from url=(0023)https://docs.oracle.com -->

<html xml:lang="en-us" lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Uploading and Displaying BLOBs</title>
      <meta property="og:site_name" content="Oracle Help Center">
      <meta property="og:title" content="2 Day + PHP Developer's Guide">
      <meta property="og:description" content="">
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css">
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico">
      <meta name="application-name" content="2 Day + PHP Developer's Guide">
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)">
      <meta name="plugin" content="SP_docbuilder HTML plugin release 17.8.1">
      <link rel="alternate" href="2-day-php-developers-guide.pdf" title="PDF File" type="application/pdf">
      <meta name="robots" content="all">
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
      <meta name="dcterms.created" content="2017-10-18T11:39:07-07:00">
      <meta name="dcterms.title" content="2 Day + PHP Developer's Guide">
      <meta name="dcterms.dateCopyrighted" content="2010, 2017">
      <meta name="dcterms.category" content="database">
      <meta name="dcterms.identifier" content="E85807-01">
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/12.2">
      <meta name="dcterms.release" content="Release 12.2">
      <link rel="prev" href="using-JSON-and-generating-JPEG-image.html" title="Previous" type="text/html">
      <link rel="next" href="monitoring-database-usage-of-application.html" title="Next" type="text/html">
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script data-main="/sp_common/book-template/ohc-book-template/js/book-config" src="/sp_common/book-template/requirejs/require.js"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">
            {
                "primary":
                {
                    "category":{
                      "short_name":"database",
                      "element_name":"Database",
                      "display_in_url":true
                    },
                    "suite":{
                      "short_name":"oracle",
                      "element_name":"Oracle",
                      "display_in_url":true
                    },
                    "product_group":{
                      "short_name":"not-applicable",
                      "element_name":"Not applicable",
                      "display_in_url":false
                    },
                    "product":{
                      "short_name":"oracle-database",
                      "element_name":"Oracle Database",
                      "display_in_url":true
                    },
                    "release":{
                      "short_name":"12.2",
                      "element_name":"Release 12.2",
                      "display_in_url":true
                    },
                    "platform":{
                      "short_name":"",
                      "element_name":"",
                      "display_in_url":false
                    },
                    "component":{
                      "short_name":"",
                      "element_name":"",
                      "display_in_url":false
                    }
                }
            }
            </script>
      
    <meta name="dcterms.isVersionOf" content="TDPPH">
  </head>
   <body>
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="using-JSON-and-generating-JPEG-image.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>Previous</a>
         <a href="monitoring-database-usage-of-application.html" class="pull-right">Next<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>
         <span class="fa fa-exclamation-triangle" aria-hidden="true"></span> JavaScript must be enabled to correctly display this content
        
      </div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">2 Day + PHP Developer's Guide</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">Uploading and Displaying BLOBs</li>
            </ol>
            <a id="GUID-9224A4A4-4315-4AAD-AB5C-E2E8028871F9" name="GUID-9224A4A4-4315-4AAD-AB5C-E2E8028871F9"></a><a id="TDPPH183"></a>
            
            <h2 id="TDPPH-GUID-9224A4A4-4315-4AAD-AB5C-E2E8028871F9" class="sect2"><span class="enumeration_chapter">12 </span>Uploading and Displaying BLOBs
            </h2>
         </header>
         <div class="ind">
            <div>
               <p>This chapter contains the following topics:</p>
               <ul style="list-style-type: disc;">
                  <li>
                     <p><a href="uploading-and-displaying-BLOBs.html#GUID-B8FEDA08-2583-4395-844A-A4AB6EFFE74A">Creating a Table to Store the Logo</a></p>
                  </li>
                  <li>
                     <p><a href="uploading-and-displaying-BLOBs.html#GUID-61F4D855-59D1-402A-A1BD-05632D9A250F">Uploading Images in PHP OCI8</a></p>
                  </li>
                  <li>
                     <p><a href="uploading-and-displaying-BLOBs.html#GUID-5F3D0010-B6E6-4654-8F49-C72E048C8D2F">Fetching the Logo and Creating an Image</a></p>
                  </li>
                  <li>
                     <p><a href="uploading-and-displaying-BLOBs.html#GUID-F627EE37-E9F9-489A-9B09-1DC6943E9BB2">Displaying the Logo</a></p>
                  </li>
               </ul>
            </div><a id="TDPPH184"></a><div class="props_rev_3"><a id="GUID-B8FEDA08-2583-4395-844A-A4AB6EFFE74A" name="GUID-B8FEDA08-2583-4395-844A-A4AB6EFFE74A"></a><h3 id="TDPPH-GUID-B8FEDA08-2583-4395-844A-A4AB6EFFE74A" class="sect3"><span class="enumeration_section">12.1 </span>Creating a Table to Store the Logo
               </h3>
               <div>
                  <div class="section">
                     <p>The PHP OCI8 extension easily allows <code class="codeph">LOB</code> data to be manipulated. A <code class="codeph">BLOB</code> will be used in the AnyCo application to store a company logo that will be displayed on each web page.
                     </p>
                     <p>In SQL*Plus create a table <code class="codeph">PICTURES</code> to store the logo:
                     </p><pre class="oac_no_warn" dir="ltr">CREATE TABLE pictures (id NUMBER, pic BLOB);
 
CREATE SEQUENCE pictures_seq;
CREATE TRIGGER pictures_trig BEFORE INSERT ON pictures FOR EACH ROW
BEGIN
    :NEW.id := pictures_seq.NEXTVAL;
END;
/
</pre></div>
                  <!-- class="section" -->
               </div>
            </div><a id="TDPPH185"></a><div class="props_rev_3"><a id="GUID-61F4D855-59D1-402A-A1BD-05632D9A250F" name="GUID-61F4D855-59D1-402A-A1BD-05632D9A250F"></a><h3 id="TDPPH-GUID-61F4D855-59D1-402A-A1BD-05632D9A250F" class="sect3"><span class="enumeration_section">12.2 </span>Uploading Images in PHP OCI8
               </h3>
               <div>
                  <div class="section">
                     <p>Create a new PHP file <code class="codeph">ac_logo_upload.php</code>. The initial contents are:
                     </p><pre class="oac_no_warn" dir="ltr">&lt;?php
 
/**
 * ac_logo_upload.php: Upload a new company logo
 * @package Logo
 */
 
session_start();
require('ac_db.inc.php');
require('ac_equip.inc.php');
 
$sess = new \Equipment\Session;
$sess-&gt;getSession();
if (!isset($sess-&gt;username) || empty($sess-&gt;username)
        || !$sess-&gt;isPrivilegedUser()) {
    header('Location: index.php');
    exit;
}
 
$page = new \Equipment\Page;
$page-&gt;printHeader("AnyCo Corp. Upload Logo");
$page-&gt;printMenu($sess-&gt;username, $sess-&gt;isPrivilegedUser());
printcontent($sess);
$page-&gt;printFooter();
 
// Functions
 
?&gt;
</pre><p>Add the <code class="codeph">printcontent()</code> function:
                     </p><pre class="oac_no_warn" dir="ltr">/**
 * Print the main body of the page
 *
 * @param Session $sess
 */
function printcontent($sess) {
    echo "&lt;div id='content'&gt;";
    if (!isset($_FILES['lob_upload'])) {
        printform();
    } else {
        $blobdata = file_get_contents($_FILES['lob_upload']['tmp_name']);
        if (!$blobdata) {  
            // N.b. this test could be enhanced to confirm the image is a JPEG
            printform();
        } else {
            $db = new \Oracle\Db("Equipment", $sess-&gt;username);
            $sql = 'INSERT INTO pictures (pic)
                    VALUES(EMPTY_BLOB()) RETURNING pic INTO :blobbind';
            $db-&gt;insertBlob($sql, 'Insert Logo BLOB', 'blobbind', $blobdata);
            echo '&lt;p&gt;New logo was uploaded&lt;/p&gt;';
        }
    }
    echo "&lt;/div&gt;";  // content
}
</pre><p>This is in the now familiar two part structure with an HTML form and a form-handler. The <code class="codeph">INSERT</code> statement uses a bind value to represent the <code class="codeph">BLOB</code>. The new <code class="codeph">Db</code> class <code class="codeph">insertBlob()</code> will associate the <code class="codeph">BLOB</code> data with the bind variable and commit the record. The uploaded image will be added to the <code class="codeph">PICTURES</code> table.
                     </p>
                     <p>Complete <code class="codeph">ac_logo_upload.php</code> by adding the form function <code class="codeph">printform()</code>:
                     </p><pre class="oac_no_warn" dir="ltr">/**
 * Print the HTML form to upload the image
 *
 * Adding CSRF protection is an exercise for the reader
 */
function printform() {
    echo &lt;&lt;&lt;EOF
Upload new company logo:
&lt;form action="ac_logo_upload.php" method="POST" enctype="multipart/form-data"&gt;
&lt;div&gt;
   Image file name: &lt;input type="file" name="lob_upload"&gt;
   &lt;input type="submit" value="Upload"
&lt;/div&gt;
&lt;form
EOF;
}
</pre><div class="infoboxnote" id="GUID-61F4D855-59D1-402A-A1BD-05632D9A250F__GUID-25973C88-CA86-448A-97E2-2134A53C9236">
                        <p class="notep1">Note:</p>
                        <p>The <code class="codeph">EOF;</code> token must be at the start of a line and not have trailing white space.
                        </p>
                     </div>
                     <p>When this form is submitted the PHP web server will be able to access uploaded <code class="codeph">BLOB</code> data in the temporary file <code class="codeph">$_FILES['lob_upload']['tmp_name']</code>, as seen in <code class="codeph">printcontent()</code>.
                     </p>
                     <p>PHP has various options controlling locations and upper sizes of files, refer to the PHP documentation. The AnyCo application will use the default values.</p>
                     <p>Edit <code class="codeph">ac_db.inc.php</code> and add the <code class="codeph">insertBlob()</code> method to the <code class="codeph">Db</code> class:
                     </p><pre class="oac_no_warn" dir="ltr">    /**
     * Insert a BLOB
     *
     * $sql = 'INSERT INTO BTAB (BLOBID, BLOBDATA)
     *        VALUES(:MYBLOBID, EMPTY_BLOB()) RETURNING BLOBDATA
     *        INTO :BLOBDATA';
     * Db::insertblob($sql, 'do insert for X', myblobid', 
     * $blobdata, array(array(":p", $p, -1)));
     *
     * $sql = 'UPDATE MYBTAB SET blobdata = EMPTY_BLOB()
     *        RETURNING blobdata INTO :blobdata';
     * Db::insertblob($sql, 'do insert for X', 'blobdata', $blobdata);
     *
     * @param string $sql An INSERT or UPDATE statement that
     * @returns a LOB locator
     * @param string $action Action text for End-to-End Application Tracing
     * @param string $blobbindname Bind variable name of the BLOB
     * @in the statement
     * @param string $blob BLOB data to be inserted
     * @param array $otherbindvars Bind variables. An array of tuples
     */
    public function insertBlob($sql, $action, $blobbindname, $blob, 
    $otherbindvars = array()) {
        $this-&gt;stid = oci_parse($this-&gt;conn, $sql);
        $dlob = oci_new_descriptor($this-&gt;conn, OCI_D_LOB);
        oci_bind_by_name($this-&gt;stid, $blobbindname, $dlob, -1, OCI_B_BLOB);
        foreach ($otherbindvars as $bv) {
            // oci_bind_by_name(resource, bv_name, php_variable, length)
            oci_bind_by_name($this-&gt;stid, $bv[0], $bv[1], $bv[2]);
        }
        oci_set_action($this-&gt;conn, $action);
        oci_execute($this-&gt;stid, OCI_NO_AUTO_COMMIT);
        if ($dlob-&gt;save($blob)) {
            oci_commit($this-&gt;conn);
        }
    }
</pre><p>The <code class="codeph">insertBlob()</code> method accepts a final option parameter for normal bind variables. This is not used when it is called in <code class="codeph">printcontent()</code> in <code class="codeph">ac_logo_upload.php</code>.
                     </p>
                     <p>The <code class="codeph">BLOB</code> is bound as a special type, similar to how a <code class="codeph">REF CURSOR</code> was bound in the “Showing Equipment Records by Using a REF_CURSOR”. PHP OCI8 also has a <code class="codeph">OCI_B_CLOB</code> constant that can be used for binding <code class="codeph">CLOB</code>s. The <code class="codeph">LOB</code> descriptor is an instance of PHP OCI8's <code class="codeph">OCI-Lob</code> class, which has various methods for uploading and reading data. When <code class="codeph">oci_execute()</code> is processed on the SQL <code class="codeph">INSERT</code> statement the <code class="codeph">OCI_NO_AUTO_COMMIT</code> flag is used. This is because the database transaction must remain open until the<code class="codeph"> $dlob-&gt;save()</code> method inserts the data. Finally, an explicit <code class="codeph">oci_commit()</code> commits the <code class="codeph">BLOB</code>.
                     </p>
                     <p>Run the AnyCo application in a browser and log in Administrator. Click the <span class="bold">Upload Logo</span> link in the left hand menu. Locate a JPEG image on your computer and select it. The next section of this chapter will display the image in the page header with the title, so choose an image of 15 to 20 pixels in height.
                     </p>
                     <div class="figure" id="GUID-61F4D855-59D1-402A-A1BD-05632D9A250F__GUID-489997A5-86E2-4710-A3EE-C084AE3159F0"><img src="img/chap12_php_oci8.png" width="520" alt="Upload logo page" title="Upload logo page"></div>
                     <!-- class="figure" -->
                     <p>Click the <span class="bold">Upload</span> button.
                     </p>
                  </div>
                  <!-- class="section" -->
               </div>
               <div>
                  <div class="relinfo">
                     <p><strong>Related Topics</strong></p>
                     <ul>
                        <li><a href="showing-equipment-records-using-REF-CURSOR.html#GUID-81593889-92ED-48C5-B1EE-F2BBBF60F64F">Showing Equipment Records by Using a REF CURSOR</a></li>
                     </ul>
                  </div>
               </div>
               
            </div><a id="TDPPH186"></a><div class="props_rev_3"><a id="GUID-5F3D0010-B6E6-4654-8F49-C72E048C8D2F" name="GUID-5F3D0010-B6E6-4654-8F49-C72E048C8D2F"></a><h3 id="TDPPH-GUID-5F3D0010-B6E6-4654-8F49-C72E048C8D2F" class="sect3"><span class="enumeration_section">12.3 </span>Fetching the Logo and Creating an Image
               </h3>
               <div>
                  <div class="section">
                     <p>Displaying the logo is similar in concept to how the graph image was displayed in the previous chapter. However since the <code class="codeph">BLOB</code> is already in JPEG format the GD extension is not required.
                     </p>
                     <p>Create a new PHP file <code class="codeph">ac_logo_img.php</code>. The file contains:
                     </p><pre class="oac_no_warn" dir="ltr">&lt;?php
 
/**
 * ac_logo_img.php: Create a JPEG image of the company logo
 *
 * do not have any text or white space before the "&lt;?php" tag because it will
 * be incorporated into the image stream and corrupt the picture.
 *
 * @package Logo
 */
 
session_start();
require('ac_db.inc.php');
require('ac_equip.inc.php');
 
$sess = new \Equipment\Session;
$sess-&gt;getSession();
if (isset($sess-&gt;username) &amp;&amp; !empty($sess-&gt;username)) {
    $username = $sess-&gt;username;
} else { // index.php during normal execution, or other external caller
    $username = "unknown-logo";
}
 
$db = new \Oracle\Db("Equipment", $username);
$sql = 'SELECT pic FROM pictures WHERE id = (SELECT MAX(id) FROM pictures)';
$img = $db-&gt;fetchOneLob($sql, "Get Logo", "pic");
 
header("Content-type: image/jpg");
echo $img;
 
?&gt;
</pre><p>This queries the most recent logo and sends it back as a JPEG stream. If the image appears corrupted, comment out the <code class="codeph">header()</code> and <code class="codeph">echo</code> function calls and check if any text or white space is being emitted by the script.
                     </p>
                     <p>The user name check differs from those used in previous sections. The logo is displayed on all pages including the login page before the web user name is known. Because <code class="codeph">Db</code> accepts a user name for end-to-end tracing, <code class="codeph">ac_logo_img.php</code> uses a bootstrap user name <code class="codeph">unknown-logo</code>.
                     </p>
                     <p>Edit <code class="codeph">ac_db.inc.php</code> and add the <code class="codeph">fetchOneLob()</code> method to the <code class="codeph">Db</code> class:
                     </p><pre class="oac_no_warn" dir="ltr">    /**
     * Runs a query that fetches a LOB column
     * @param string $sql A query that include a LOB column in the select list
     * @param string $action Action text for End-to-End Application Tracing
     * @param string $lobcolname The column name of the LOB in the query
     * @param array $bindvars Bind variables. An array of tuples
     * @return string The LOB data
     */
    public function fetchOneLob($sql, $action, $lobcolname, 
                                $bindvars = array()) {
        $col = strtoupper($lobcolname);
        $this-&gt;stid = oci_parse($this-&gt;conn, $sql);
        foreach ($bindvars as $bv) {
            // oci_bind_by_name(resource, bv_name, php_variable, length)
            oci_bind_by_name($this-&gt;stid, $bv[0], $bv[1], $bv[2]);
        }
        oci_set_action($this-&gt;conn, $action);
        oci_execute($this-&gt;stid);
        $row = oci_fetch_array($this-&gt;stid, OCI_RETURN_NULLS);
        $lob = null;
        if (is_object($row[$col])) {
            $lob = $row[$col]-&gt;load();
            $row[$col]-&gt;free();
        }
        $this-&gt;stid = null;
        return($lob);
    }
</pre><p>The <code class="codeph">oci_fetch_array()</code> options could have included the <code class="codeph">OCI_RETURN_LOBS</code> flag to indicate the data should be returned as a PHP string. The code here shows the column being returned as a locator instead. This shows how a locator can be operated on, here using the <code class="codeph">load()</code> to read all the data and <code class="codeph">free()</code> method to free up resources. If you had an application with very large data, the locator <code class="codeph">read()</code> method could be used to process the <code class="codeph">LOB</code> in chunks, which would be a memory efficient way of processing large data streams.
                     </p>
                     <p>Unlike <code class="codeph">insertBlob()</code>, which bound using the <code class="codeph">OCI_B_BLOB</code> type and was therefore specific for <code class="codeph">BLOB</code>s, the <code class="codeph">fetchOneLob()</code> can be used for both <code class="codeph">BLOB</code> and <code class="codeph">CLOB</code> data.
                     </p>
                     <p>If an application processes multiple images (or chunks of an image) sequentially in a loop, for example:</p><pre class="oac_no_warn" dir="ltr">  while (($img = $db-&gt;fetchOneLob($sql, "Get Logo", "pic")) != null ) {
      dosomething($img);
  }
</pre><p>then you can reduce PHP's peak memory usage by explicitly un-setting <code class="codeph">$img</code> at the foot of the loop:
                     </p><pre class="oac_no_warn" dir="ltr">      dosomething($img);
      $unset($img);
</pre><p>This allows the memory allocated for the current <code class="codeph">$img</code> to be reused for the next image data stream. Otherwise the original image memory is only freed after PHP constructs the second image and is ready to assign it to <code class="codeph">$img</code>. This optimization is not needed by the AnyCo application.
                     </p>
                  </div>
                  <!-- class="section" -->
               </div>
            </div><a id="TDPPH187"></a><div class="props_rev_3"><a id="GUID-F627EE37-E9F9-489A-9B09-1DC6943E9BB2" name="GUID-F627EE37-E9F9-489A-9B09-1DC6943E9BB2"></a><h3 id="TDPPH-GUID-F627EE37-E9F9-489A-9B09-1DC6943E9BB2" class="sect3"><span class="enumeration_section">12.4 </span>Displaying the Logo
               </h3>
               <div>
                  <div class="section">
                     <p>To display an uploaded logo in the AnyCo application, edit <code class="codeph">ac_equip.inc.php</code> and un-comment the <code class="codeph">LOGO_URL</code> definition:
                     </p><pre class="oac_no_warn" dir="ltr">define('LOGO_URL', 'http://localhost/ac_logo_img.php');
</pre><p>Make sure the URL is correct for your environment.</p>
                     <p>The logo is displayed in <code class="codeph">Page::printHeader()</code>. Every standard page of the application will show the logo. Rerun the application to verify this:
                     </p>
                     <div class="figure" id="GUID-F627EE37-E9F9-489A-9B09-1DC6943E9BB2__GUID-ECFF0A35-09EB-4704-AE9F-023011EC68B0"><img width="520" src="img/chap12_logo.png" alt="Displaying the Logo" title="Displaying the Logo"></div>
                     <!-- class="figure" -->
                     <p>Keeping images in the database allows the complete application data to be backed up and shared across all applications. However for performance you could consider implementing a caching technique that writes the logo to disk so it can be streamed directly without requiring the overhead of database access. The upload form could regenerate the disk file each time a new image is uploaded.</p>
                  </div>
                  <!-- class="section" -->
               </div>
            </div>
         </div>
      </article>
   </body>
</html>